!function(t){t.add("plugin","imagemanager",{translations:{en:{choose:"Archive"}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.$pagi=null,this.$pagiOpt=null},onmodal:{image:{open:function(t,i){this.opts.imageManagerJson&&this._load(t)}}},_load:function(i){var a=i.getBody();this.$box=t.dom("<div>"),this.$box.attr("data-title",this.lang.get("choose")),this.$box.addClass("redactor-modal-tab"),this.$box.html("<input class='form-control mb-3' id='img_search' placeholder='Search...' /><div id='imgList'></div><div id='pagiDiv'><div id=\"pagi\" class=\"mt-3\"></div></div>"),this.$box.hide(),this.$box.css({overflow:"auto","min-height":"300px","line-height":1}),a.append(this.$box),t.ajax.get({url:this.opts.imageManagerJson,success:this._parse.bind(this)}),this.$pagiOpt={paginationClass:"pagination justify-content-center",startPage:1,totalPages:1,visiblePages:1,onPageClick:function(t,i){this.$pagiOpt.startPage!=i&&this._loadData(i)}.bind(this)},this.$pagi=$("#pagi").twbsPagination(this.$pagiOpt);var s=null;$("#img_search").on("keyup",function(){clearTimeout(s),s=setTimeout(function(){this._loadData(1,$("#img_search").val())}.bind(this),400)}.bind(this))},_loadData:function(i,a){var s=a?"&search="+a:"";s+=i?"&page="+i:"",t.ajax.get({url:this.opts.imageManagerJson+"?"+s,success:this._parse.bind(this)})},_parse:function(i){var a=i;if(this.$box.find("#imgList").html(""),i.data){for(var s in i.data){if("object"==typeof(p=i.data[s])){var e=this.opts.imageManagerPrefix+p.path,o={thumb:e.replace("redactor/","redactor/sm_"),url:e.replace("redactor/","redactor/lg_"),title:p.name,id:p.id},n=t.dom("<img>"),r=e.replace("redactor/","redactor/sm_");n.attr("src",r),n.attr("data-params",encodeURI(JSON.stringify(o))),n.css({width:"96px",height:"72px",margin:"0 4px 2px 0",cursor:"pointer"}),n.on("click",this._insert.bind(this)),this.$box.find("#imgList").append(n)}}this.$pagi.twbsPagination("destroy"),this.$pagi.remove(),$("#pagiDiv").html('<div id="pagi" class="mt-3"></div>'),this.$pagi=$("#pagi"),this.$pagiOpt.startPage=a.current_page,this.$pagiOpt.totalPages=a.last_page,this.$pagiOpt.visiblePages=a.last_page>=5?5:a.last_page,this.$pagi.twbsPagination(this.$pagiOpt)}else for(var s in i){var p;if("object"==typeof(p=i[s])){n=t.dom("<img>"),r=p.thumb?p.thumb:p.url;n.attr("src",r),n.attr("data-params",encodeURI(JSON.stringify(p))),n.css({width:"96px",height:"72px",margin:"0 4px 2px 0",cursor:"pointer"}),n.on("click",this._insert.bind(this)),this.$box.append(n)}}},_insert:function(i){i.preventDefault();var a=t.dom(i.target),s=JSON.parse(decodeURI(a.attr("data-params")));this.app.api("module.image.insert",{image:s})}})}(Redactor);